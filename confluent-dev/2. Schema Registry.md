# Produce dan Consume menggunakan Schema Registry

## Produce dan Consume menggunakan Schema Registry di Java

Pertama, pastikan status schema registry pada vm confluent sudah running dan port 8081 bisa di-telnet dari client:

```
sudo systemctl status confluent-schema-registry
```

![image](https://github.com/user-attachments/assets/0ba14b8e-575d-495e-bb43-097ed45a34e7)

Pada file `pom.xml`, tambahkan library berikut di bagian Dependency:

```
<!-- Confluent Kafka Avro Serializer -->
<dependency>
        <groupId>io.confluent</groupId>
        <artifactId>kafka-avro-serializer</artifactId>
        <version>7.0.0</version>
</dependency>

<!-- Avro -->
<dependency>
    <groupId>org.apache.avro</groupId>
    <artifactId>avro</artifactId>
    <version>1.10.2</version>
</dependency>
```

Ubah kode di file `Producer.java` hingga menjadi seperti berikut:

```
package com.example;

import org.apache.kafka.clients.producer.*;
import org.apache.kafka.common.serialization.StringSerializer;

import io.confluent.kafka.serializers.KafkaAvroSerializer;
import org.apache.avro.Schema;
import org.apache.avro.generic.GenericData;
import org.apache.avro.generic.GenericRecord;

import java.util.Properties;

public class Producer {
    public static void main(String[] args) {
        String bootstrapServers = "10.100.13.149:9092";
        String schemaRegistryUrl = "http://10.100.13.149:8081";
        String topic = "test_topic";

        // Avro schema definition
        String userSchema = 
        "{"
            + "\"type\": \"record\","
            + "\"name\": \"User\","
            + "\"fields\": ["
                + "{ \"name\": \"name\", \"type\": \"string\" },"
                + "{ \"name\": \"age\", \"type\": \"int\" }"
            + "]"
        + "}";

        Schema.Parser parser = new Schema.Parser();
        Schema schema = parser.parse(userSchema);

        // Create a GenericRecord with the schema
        GenericRecord avroRecord = new GenericData.Record(schema);
        avroRecord.put("name", "Ivy");
        avroRecord.put("age", 21);

        // Producer properties
        Properties properties = new Properties();
        properties.setProperty(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, bootstrapServers);
        properties.setProperty(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());
        properties.setProperty(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, KafkaAvroSerializer.class.getName());
        properties.setProperty("schema.registry.url", schemaRegistryUrl);  // Setting Schema Registry URL

        // Create the producer
        KafkaProducer<String, GenericRecord> producer = new KafkaProducer<>(properties);

        // Send data
        ProducerRecord<String, GenericRecord> record = new ProducerRecord<>(topic, "key", avroRecord);
        producer.send(record, (metadata, exception) -> {
            if (exception == null) {
                System.out.println("Sent message with offset: " + metadata.offset());
            } else {
                exception.printStackTrace();
            }
        });

        // Flush and close producer
        producer.flush();
        producer.close();
    }
}
```

Berdasarkan kode di atas, berikut adalah library-library tambahan yang diimport untuk menggunakan schema registry.

```
import io.confluent.kafka.serializers.KafkaAvroSerializer;
import org.apache.avro.Schema;
import org.apache.avro.generic.GenericData;
import org.apache.avro.generic.GenericRecord;
```

Berikut adalah konfigurasi yang ditambahkan:

```
String schemaRegistryUrl = "http://10.100.13.149:8081";

// Avro schema definition
String userSchema = 
"{"
    + "\"type\": \"record\","
    + "\"name\": \"User\","
    + "\"fields\": ["
        + "{ \"name\": \"name\", \"type\": \"string\" },"
        + "{ \"name\": \"age\", \"type\": \"int\" }"
    + "]"
+ "}";
Schema.Parser parser = new Schema.Parser();
Schema schema = parser.parse(userSchema);

// Create a GenericRecord with the schema
GenericRecord avroRecord = new GenericData.Record(schema);
avroRecord.put("name", "Ivy");
avroRecord.put("age", 21);
```

Dengan kode di atas, message ditetapkan untuk mengikuti format userSchema yang menyertakan nama dan umur. Lalu, pastikan value yang dikirim diambil dari avroRecord, bukan string yang sebelumnya.

```
properties.setProperty(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, KafkaAvroSerializer.class.getName());
properties.setProperty("schema.registry.url", schemaRegistryUrl);  // Setting Schema Registry URL

// Create the producer
KafkaProducer<String, GenericRecord> producer = new KafkaProducer<>(properties);

// Send data
ProducerRecord<String, GenericRecord> record = new ProducerRecord<>(topic, "key", avroRecord);
```

