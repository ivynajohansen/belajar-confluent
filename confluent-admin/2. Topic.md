# Topic

## Tuning Producer Performance

### 1. Buat Topic

Buat topic bernama `chat-messages` untuk menampung message berupa pesan chat.

```
confluent kafka topic create chat-messages --partitions 3 --replication-factor 1 --if-not-exists --url http://10.100.13.149:8090/kafka
```

String `--url` adalah Base URL dari REST Proxy Endpoint Kafka Cluster. Gunakan `http://10.100.13.149:8090/kafka` untuk memakai Embedded Kafka REST Proxy dan gunakan `http://10.100.13.149:8082` untuk memakai Standard Kafka REST Proxy.

Jika punya broker lebih, tambahkan `replication-factor` supaya performance test bisa lebih akurat dengan `ack = all`.

### 2. Producer Performance Test

Lakukan test performa untuk producer dengan command berikut:

```
kafka-producer-perf-test \
    --topic chat-messages \
    --num-records 1000000 \
    --record-size 100 \
    --throughput 10000000 \
    --producer-props \
    bootstrap.servers=10.100.13.149:9092 \
    acks=1 \
    batch.size=400000 \
    linger.ms=500
```

- `num-records`: Jumlah total message yang akan diproduce. Pada command diatas, produser akan mengirimkan 1 juta pesan ke topik `chat-messages`.
- `record-size`: Size setiap message dalam byte.
- `throughput`: Rate maksimum message per detik.
- `acks`: Jumlah acknowledgment yang diminta producer dari broker sebelum menganggap message berhasil dikirim. Karena topic hanya menggunakan 1 replication factor, `ack` disetel ke `1`, yang producer menunggu acknowlegement dari broker.
- `batch.size`: Size maksimum batch message yang dikirim ke broker Kafka. Parameter ini mengontrol berapa banyak message yang dikirim dalam satu request, yang dapat meningkatkan performa dengan mengurangi jumlah request yang dikirim ke broker.
- `linger.ms`: Jumlah waktu tunggu producer sebelum mengirim sejumlah message ke broker. Parameter ini juga dapat meningkatkan performa dengan membiarkan producer mengelompokkan pesan sebelum mengirimkannya.

Hasil:

![image](https://github.com/ivynajohansen/belajar-confluent/assets/83331802/bea3eef4-5b88-4367-9d65-e348865466df)

Pada screenshot hasil di atas,
`throughput`: 543478.260870 records/sec (51.83 MB/sec)
`latency`: 16.56 ms (466.00 ms max)

Sekarang lalukan test performa yang sama, namun dengan `ack` yang berbeda, yaitu 0:

![image](https://github.com/ivynajohansen/belajar-confluent/assets/83331802/6991d3f9-cb8a-4305-87c7-8f0017c1feaa)

Berdasarkan hasil testing diatas, dapat disimpulkan seperti berikut:

| Variables | Throughput (MB/sec) | Latency (ms avg) |
|-----------|---------------------|------------------|
| acks=1    | 50.41               | 18.83            |
| acks=0    | 59.42               | 8.68             |

Dalam `ack=0`, producer sama sekali tidak menunggu acknowledgment dari broker. Mode ini dapat menghasilkan produksi message tercepat namun dengan risiko kehilangan message tertinggi.

Sekarang, dengan `ack=1`, ubah value batch.size antara 1 dan 1.000.000 dan nilai linger.ms antara 0 dan 3.000.

| Batch Size | Linger (ms) | Throughput (MB/sec) | Latency (ms avg) |
|------------|-------------|---------------------|------------------|
| 50000      | 25          | 63.07               | 2.48             |
|            | 500         | 65.01               | 3.09             |
|            | 1500        | 64.26               | 2.18             |
|            | 3000        | 63.92               | 2.65             |
| 250000     | 25          | 66.04               | 3.01             |
|            | 500         | 63.92               | 4.04             |
|            | 1500        | 65.50               | 2.85             |
|            | 3000        | 63.28               | 3.39             |
| 500000     | 25          | 62.66               | 6.56             |
|            | 500         | 65.73               | 5.87             |
|            | 1500        | 67.35               | 5.23             |
|            | 3000        | 64.96               | 4.99             |
| 1000000    | 25          | 66.00               | 9.87             |
|            | 500         | 66.78               | 10.61            |
|            | 1500        | 64.79               | 9.50             |
|            | 3000        | 65.73               | 9.45             |

Berdasarkan hasil experimen di atas, throughput tidak jauh berbeda jika batch size atau linger diubah, namun latency membesar semakin besarnya batch size.

> Hasil mungkin kurang akurat karena tidak adanya broker follower

## Tuning Consumer Performance

Consume data dari topic `chat-messages` dengan Consumer Group `chat-consumer-group`

```
kafka-consumer-perf-test \
        --bootstrap-server 10.100.13.149:9092 \
        --topic chat-messages \
        --group chat-consumer-group \
        --messages 10000000 \
        --show-detailed-stats \
        --reporting-interval 5000
```

Hasil dari test di atas:

| time                 | threadId | data.consumed.in.MB | MB.sec  | data.consumed.in.nMsg | nMsg.sec     | rebalance.time.ms | fetch.time.ms | fetch.MB.sec | fetch.nMsg.sec |
|----------------------|----------|----------------------|---------|-----------------------|--------------|-------------------|---------------|--------------|----------------|
| 2024-06-22 16:40:29  | 0        | 713.8124             | 135.3456| 7484866               | 1419200.9860| 521               | 4753          | 150.1815     | 1574766.6737  |
| 2024-06-22 16:40:34  | 0        | 728.6913             | 2.9522  | 7640882               | 30955.5556  | 0                 | 5040          | 2.9522       | 30955.5556    |
| 2024-06-22 16:40:39  | 0        | 743.1095             | 2.8727  | 7792068               | 30122.7336  | 0                 | 5019          | 2.8727       | 30122.7336    |
| 2024-06-22 16:40:44  | 0        | 757.6308             | 2.8852  | 7944335               | 30253.7254  | 0                 | 5033          | 2.8852       | 30253.7254    |

Buat file bernama `consumer.properties` yang isinya:

```
fetch.min.bytes=10485760
```

Jalankan `kafka-consumer-perf-test` lagi dengan konfigurasi `consumer.properties` di atas.

```
kafka-consumer-perf-test \
    --bootstrap-server 10.100.13.149:9092 \
    --topic chat-messages \
    --group chat-consumer-group \
    --messages 10000000 \
    --show-detailed-stats \
    --reporting-interval 5000 \
    --consumer.config /root/consumer.properties
```

| time                | threadId | data.consumed.in.MB | MB.sec | data.consumed.in.nMsg | nMsg.sec | rebalance.time.ms | fetch.time.ms | fetch.MB.sec | fetch.nMsg.sec |
|---------------------|----------|----------------------|--------|-----------------------|----------|--------------------|---------------|--------------|----------------|
| 2024-06-22 16:49:01 | 0        | 2.4240               | 0.4789 | 25418                 | 5021.3354| 404                | 4658          | 0.5204       | 5456.8484     |
| 2024-06-22 16:49:06 | 0        | 14.0247              | 2.2926 | 147060                | 24039.9209| 0                 | 5060          | 2.2926       | 24039.9209    |
| 2024-06-22 16:49:11 | 0        | 25.3801              | 2.2571 | 266130                | 23667.2630| 0                 | 5031          | 2.2571       | 23667.2630    |
| 2024-06-22 16:49:16 | 0        | 35.9403              | 2.0978 | 376861                | 21996.6230| 0                 | 5034          | 2.0978       | 21996.6230    |

Kali ini, konsumsi data jauh lebih kecil dibandingkan tanpa `fetch.min.bytes`. Jadi, value `fetch.min.bytes` yang lebih tinggi dapat menyebabkan tingkat konsumsi lebih lambat namun juga dapat mengurangi jumlah fetch request dan berpotensi meningkatkan efisiensi secara keseluruhan, terutama dalam skenario dengan throughput pesan yang tinggi. Penting untuk menjaga keseimbangan dan menyesuaikan pengaturan ini berdasarkan kebutuhan spesifik dan pertimbangan kinerja.

## Data Retention

## Topic Management
